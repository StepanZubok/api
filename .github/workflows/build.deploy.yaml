name: Build and deploy code
on: [push, pull_request]

env:
  DATABASE_HOSTNAME: localhost
  DATABASE_PORT: 5432
  DATABASE_PASSWORD: 12345
  DATABASE_NAME: fastapi
  DATABASE_USERNAME: postgres
  SECRET_KEY: "abc"
  ALGORITHM: "HS256"
  ACCESS_TOKEN_EXPIRE_MINUTES: 30

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest
          pytest

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.AUTH_KEY }}
      
      - name: Deploy via SSH
        env:
          KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          PASS: ${{ secrets.SSH_PASSPHRASE }}
          SUDO: ${{ secrets.SUDO_PASSWORD }}
        run: |
          sudo apt-get install -y expect openssh-client
          mkdir -p ~/.ssh
          printf '%s\n' "$KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 6996 100.76.67.39 >> ~/.ssh/known_hosts
          eval "$(ssh-agent -s)"
          expect << 'EOF'
          set timeout 20
          spawn ssh-add $env(HOME)/.ssh/id_rsa
          expect {
            "passphrase" { send "$env(PASS)\r"; exp_continue }
            eof
          }
          EOF
          ssh -o StrictHostKeyChecking=no -p 6996 stefan@100.76.67.39 \
            "cd app/api && git pull && echo '${SUDO}' | sudo -S systemctl restart fastapi"